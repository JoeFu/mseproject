<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="../favicon.ico">
  <title>Dashboard</title>

  <!-- Bootstrap core CSS -->
  <link href="../css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link href="../css/dashboard1.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/jquery-ui.min.css">
  <link rel="stylesheet" href="../css/jquery-ui.structure.min.css">
  <link rel="stylesheet" href="../css/jquery-ui.theme.min.css">
  <link rel="stylesheet" href="../css/jquery-ui-AutoComplete.css">

  <script type="text/javascript" src="../js/jquery-3.2.1.js"></script>
  <script src="../js/jquery-ui.min.js"></script>
  <script src="../js/jquery-ui-AutoComplete.js"></script>
  <!--Baidu Echarts JS control-->
  <script src="../js/echarts.js"></script>
</head>
<body>
<nav class="navbar navbar-toggleable-md navbar-inverse fixed-top bg-inverse">
  <button class="navbar-toggler navbar-toggler-right hidden-lg-up" type="button" data-toggle="collapse"
            data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false"
            aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a class="navbar-brand" href="#">Dashboard</a>
  <div class="collapse navbar-collapse" id="navbarsExampleDefault">
    <ul class="navbar-nav mr-auto">
	  <li class="nav-item active">
	    <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
	  </li>
	  <li class="nav-item">
	    <a class="nav-link" href="../index.html">Back</a>
	  </li>
    </ul>
    <form class="form-inline mt-2 mt-md-0">
      <input class="form-control mr-sm-2" type="text" placeholder="Search">
      <button class="btn btn-info" type="submit">Search</button>
    </form>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <nav class="col-sm-3 col-md-2 hidden-xs-down bg-faded sidebar">
      <ul class="nav nav-pills flex-column">
        <li class="nav-item">
          <a class="nav-link active" href="./MoodleCharts.html">Moodle charts<span class="sr-only">(current)</span></a>
        </li>
		<li class="nav-item">
          <a class="nav-link" href="WebSubmissionCharts.html">WebSubmission charts</a>
        </li>
      </ul>
    </nav>
    <main class="col-sm-9 offset-sm-3 col-md-10 offset-md-2 pt-3">
      <h1>Dashboard</h1>
	  <select id="SelectCourse">
	    <option  id="PleaseSelectCourse">Select course</option>
      </select>
	  <select id="SelectYear">
	    <option  id="PleaseSelectYear">SelectYear</option>
	  </select>
	  <select id="SelectSemester">
	    <option  id="PleaseSelectSemester">SelectSemester</option>
	  </select>
	  <select id="SelectAssignment">
		<option  id="PleaseSelectAssignment">SelectAssignment</option>
	  </select>
	  <div id="SemesterInformation">
        </br>
	    <label>Semester start day (YYYYMMDD):</label>
	    <label id="SemesterStartDay"></label>
		</br>
		<label>Semester end day (YYYYMMDD):</label>
	    <label id="SemesterEndDay"></label>
	  </div>
	  <div id="AssignmentInformation">
	  </div>
	  </br></br>
	  
<script type="text/javascript">
$(document).ready(function() {
	//Load data for select course
	$.ajax({
		type: "get",
		async: true, 
		url: "controller.php?type=loadCourse",
		dataType: "json", 
		success: function(result) {
			var CourseName = [];
			$.each(result,function(i,p){
				CourseName[i]=p['CourseName'];
				$("#SelectCourse").append(
					" <option id='" + CourseName[i] + "'>"+ CourseName[i] + "</option>");
			});
		}
	});

	//When users select course, load options for "select year"
	$("#SelectCourse").change(function() {
		// When users select course, remove all options in year and semester
		$("#SelectYear option").remove();
		$("#SelectSemester option").remove();
		$("#SelectAssignment option").remove();
		$("#SelectYear").append(
			" <option id='PleaseSelectYear'>SelectYear</option>");
		$("#SelectSemester").append(
			" <option id='PleaseSelectSemester'>SelectSemester</option>");
		$("#SelectAssignment").append(
			" <option id='PleaseSelectAssignment'>SelectAssignment</option>");
		 //Get the course user chooses
		var SelectCourseId=$("#SelectCourse option:selected").attr("id");
		$.ajax({
			type: "get",
			async: true, 
			url: "controller.php?type=loadYear",
			dataType: "json", 
			data: {"SelectCourseId":SelectCourseId},
			success: function(result) {
				var SchoolYear = [];
				$.each(result,function(i,p){
					SchoolYear[i]=p['SchoolYear'];
					$("#SelectYear").append(
						" <option id='" + SchoolYear[i] + "'>"
						+ SchoolYear[i] + "</option>");
				});
			}
		});//ajax
	});//change()

	//When users select course and year, load options for "select semester"
	$("#SelectYear").change(function() {
		// When users select course and year, remove all options in semester
		$("#SelectSemester option").remove();
		$("#SelectAssignment option").remove();
		$("#SelectSemester").append(
			" <option id='PleaseSelectSemester'>SelectSemester</option>");
		$("#SelectAssignment").append(
			" <option id='PleaseSelectSemester'>SelectAssignment</option>");
		//Get the course and year user chooses
		var SelectCourseId=$("#SelectCourse option:selected").attr("id");
		var SelectYearId=$("#SelectYear option:selected").attr("id");
		$.ajax({
			type: "get",
			async: true, 
			url: "controller.php?type=loadSemester",
			dataType: "json", 
			data: {"SelectCourseId":SelectCourseId,"SelectYearId":SelectYearId},
			success: function(result) {
				var Semester = [];
				$.each(result,function(i,p){
					Semester[i]=p['Semester'];
					$("#SelectSemester").append(
						" <option id='" + Semester[i] + "'>"
						+ Semester[i] + "</option>");
				});
			}
		});//ajax
	});//change()

	//When users select course, year, semester load options for "select assignment"
	$("#SelectSemester").change(function() {
		// When users select course and year, remove all options in semester
		$("#SelectAssignment option").remove();
		$("#SelectAssignment").append(
			" <option id='PleaseSelectSemester'>SelectAssignment</option>");
		 //Get the course and year user chooses
		var SelectCourseId=$("#SelectCourse option:selected").attr("id");
		var SelectYearId=$("#SelectYear option:selected").attr("id");
		var SelectSemesterId=$("#SelectSemester option:selected").attr("id");				
		 $.ajax({
			type: "get",
			async: true, 
			url: "controller.php?type=loadAssignment",
			dataType: "json", 
			data: {"SelectCourseId":SelectCourseId,"SelectYearId":SelectYearId,"SelectSemesterId":SelectSemesterId},
			success: function(result) {
				var AssignmentName = [];
				$.each(result,function(i,p){
					AssignmentName[i]=p['AssignmentName'];
					$("#SelectAssignment").append(
						" <option id='" + AssignmentName[i] + "'>"
						+ AssignmentName[i] + "</option>");
				});
			}
		});//ajax
	});//change()

	//after user selects semester, update the start day and end day (the value in the input box) of all the charts and update all the charts
	$('#SelectSemester').change(function () {
		var SelectCourseId = $("#SelectCourse option:selected").attr("id");
		var SelectYearId = $("#SelectYear option:selected").attr("id");
		var SelectSemesterId = $("#SelectSemester option:selected").attr("id");
		var PeriodFrom;
		var PeriodTo;
		switch (SelectYearId) {
			//the start day and end day of semesters in different years are different
			case "2012":
				if (SelectSemesterId=="Semester 1") {
					PeriodFrom = SelectYearId + "0227";
					PeriodTo = SelectYearId + "0630";
					$("#StudentActivitiesOverviewFrom").val(PeriodFrom);
					$("#StudentActivitiesOverviewTo").val(PeriodTo);
				} else if (SelectSemesterId=="Semester 2") {
					PeriodFrom = SelectYearId + "0723";
					PeriodTo = SelectYearId + "1117";
					$("#StudentActivitiesOverviewFrom").val(PeriodFrom);
					$("#StudentActivitiesOverviewTo").val(PeriodTo);
				}
				break;
			case "2013":
				if (SelectSemesterId=="Semester 1") {
					PeriodFrom = SelectYearId + "0304";
					PeriodTo = SelectYearId + "0705";
					$("#StudentActivitiesOverviewFrom").val(PeriodFrom);
					$("#StudentActivitiesOverviewTo").val(PeriodTo);
				} else if (SelectSemesterId=="Semester 2") {
					PeriodFrom = SelectYearId + "0729";
					PeriodTo = SelectYearId + "1122";
					$("#StudentActivitiesOverviewFrom").val(PeriodFrom);
					$("#StudentActivitiesOverviewTo").val(PeriodTo);
				}
				break;
			case "2014":
				if (SelectSemesterId=="Semester 1") {
					PeriodFrom = SelectYearId + "0303";
					PeriodTo = SelectYearId + "0704";
					$("#StudentActivitiesOverviewFrom").val(PeriodFrom);
					$("#StudentActivitiesOverviewTo").val(PeriodTo);
				} else if (SelectSemesterId=="Semester 2") {
					PeriodFrom = SelectYearId + "0728";
					PeriodTo = SelectYearId + "1121";
					$("#StudentActivitiesOverviewFrom").val(PeriodFrom);
					$("#StudentActivitiesOverviewTo").val(PeriodTo);
				}
				break;
		}
		
		// display semester start day, end day
		$("#SemesterStartDay").html(PeriodFrom); 
        $("#SemesterEndDay").html(PeriodTo);
		displayAssignmentInformation();

		// update all charts
		studentActivitiesOverviewUpdate();
	})//$('#SelectSemester').change()

	//after user selects assignment, update the start day and end day (the value in the input box) of all the charts and update all the charts
	$('#SelectAssignment').change(function () {
		getAssignmentStartDueDayAndUpdateAllCharts();
	})//$('#SelectAssignment').change()
})//DocumentReady()

//display assignment name, the start day and due day of all assignments (given the course, year, semester)
function displayAssignmentInformation() {
	var SelectCourse=$("#SelectCourse option:selected").attr("id");
	var SelectYear=$("#SelectYear option:selected").attr("id");
	var SelectSemester=$("#SelectSemester option:selected").attr("id");

	$.ajax({
		type: "get",
		async: true, //asynchronous
		url: "controller.php?type=getAssignmentInformation",
		dataType: "json", //return JSON data
		data: {"SelectCourse":SelectCourse,"SelectYear":SelectYear,"SelectSemester":SelectSemester},
		success: function (result) {
			$("#AssignmentInformation").empty();
			$.each(result, function (i, p) {
				$("#AssignmentInformation").append("<p>"+p['AssignmentName']+" start day (YYYYMMDD): "+p['StartDate']+"</p>"); 
				$("#AssignmentInformation").append("<p>"+p['AssignmentName']+" due day (YYYYMMDD): "+p['DueDate']+"</p>"); 
			});
		}//success
	});//ajax
}//function displayAssignmentInformation()

//update the start day and end day (the value in the input box) of all the charts and update all the charts
function getAssignmentStartDueDayAndUpdateAllCharts() {
	var SelectCourse=$("#SelectCourse option:selected").attr("id");
	var SelectYear=$("#SelectYear option:selected").attr("id");
	var SelectSemester=$("#SelectSemester option:selected").attr("id");
	var SelectAssignment=$("#SelectAssignment option:selected").attr("id");

	$.ajax({
		type: "get",
		async: true, //asynchronous
		url: "controller.php?type=getAssignmentStartAndDueDay",
		dataType: "json", //return JSON data
		data: {"SelectCourse":SelectCourse,"SelectYear":SelectYear,"SelectSemester":SelectSemester,"SelectAssignment":SelectAssignment},
		success: function (result) {
			$.each(result, function (i, p) {
				$("#StudentActivitiesOverviewFrom").val(p['StartDate']);
				$("#StudentActivitiesOverviewTo").val(p['DueDate']);
				// update all the charts 
				studentActivitiesOverviewUpdate();
			});
		}//success
	});//ajax
}//function getAssignmentStartAndDueDay()
</script>

	  <div id="StudentActivitiesOverview" style="width: 800px;height:400px;"></div>
	  <div style="width: 250px;height:100px;position: relative;top: -400px;left: 820px;">
	    <label for="StudentActivitiesOverviewPresentationOrder">Change Presentation Order</label>
		<select id="StudentActivitiesOverviewPresentationOrder">
		  <option value ="1" selected = "selected">Alphabetical order</option>
		  <option value ="2">Descending order</option>
		  <option value ="3">Ascending order</option>
		</select>
		</br></br>
		<label>Set period (YYYYMMDD)</label>
		</br>
		<label>From</label>
		<input type="text" id="StudentActivitiesOverviewFrom">
		</br>
		<label>To</label>&nbsp&nbsp&nbsp&nbsp
		<input type="text" id="StudentActivitiesOverviewTo">
		<button type="button" id="StudentActivitiesOverviewSetPeriod">Set period</button></br></br>
		<label for="Threshold">Threshold (Amount of activities)</label>
		</br>
		<select id="StudentActivitiesOverviewThresholdSelect">
		  <option  value =">" selected = "selected">></option>
		  <option value =">=">>=</option>
		  <option value="<"><</option>
		  <option value="<="><=</option>
		  <option value="=">=</option>
		</select>
		<input type="text" id="StudentActivitiesOverviewThreshold" value="0">
		<button type="button" id="StudentActivitiesOverviewSetThreshold">Set threshold</button>
		</br></br>
        <button type="button" id="StudentActivitiesOverviewCSV">Export CSV</button>
      </div>
				
<script type="text/javascript">
//DatePicker for the chart "Student Activities Overview"
$(document).ready(function () {
	$("#StudentActivitiesOverviewFrom").datepicker({
		defaultDate: "+1w",
		changeMonth: true,
		changeYear: true,
		numberOfMonths: 3,
		onClose: function (selectedDate) {
			$("#StudentActivitiesOverviewTo").datepicker("option", "minDate", selectedDate);
		}
	});
	$("#StudentActivitiesOverviewTo").datepicker({
		defaultDate: "+1w",
		changeMonth: true,
		changeYear: true,
		numberOfMonths: 3,
		onClose: function (selectedDate) {
			$("#StudentActivitiesOverviewFrom").datepicker("option", "maxDate", selectedDate);
		}
	});

	//set the format (YYYYMMDD) of start date and end date for the chart "Student Activities Overview" 
	$("#StudentActivitiesOverviewFrom").datepicker("option", "dateFormat", "yymmdd");//YYYYMMDD
	$("#StudentActivitiesOverviewTo").datepicker("option", "dateFormat", "yymmdd");//YYYYMMDD
})

//Initialize e-charts instance
var myChartStudentActivitiesOverview = echarts.init(document.getElementById('StudentActivitiesOverview'));

//configuration item and data for the chart
var option = {
	title: {
		text: 'Student activities overview'
	},
	tooltip: {},
	xAxis: {
		name: 'User',
		data: []
	},
	yAxis: {
		name: 'Amount of activities'
	},
	grid: {
		x: 100,
		y2: 100
	},
	dataZoom: [
		{   // dataZoom component controls x-axis by default
			type: 'slider',
			start: 0, // left position 0%
			end: 100  // right position 100%
		}
	],
	series: [{
		name: 'Amount of activities',
		type: 'bar',
		data: []
	}],
	toolbox: {
		show: true,
		feature: {
			dataView: { readOnly: false },
			magicType: { type: ['line', 'bar'] },
			restore: {},
			saveAsImage: {}
		}
	}
};

// display the chart based on the configuration item and data
myChartStudentActivitiesOverview.setOption(option);

var StudentActivitiesOverviewAmount;//number of bars (number of records)
var StudentActivitiesOverviewDiff = 100;

function studentActivitiesOverviewUpdate() {
	var SelectCourse = $("#SelectCourse option:selected").attr("id");
	var from = $("#StudentActivitiesOverviewFrom").val();
	var to = $("#StudentActivitiesOverviewTo").val();
	var order = $('#StudentActivitiesOverviewPresentationOrder').val();
	var ThresholdSelect = $('#StudentActivitiesOverviewThresholdSelect').val();
	var Threshold = $('#StudentActivitiesOverviewThreshold').val();

	$.ajax({
		type: "get",
		async: true, //asynchronous
		url: "controller.php?type=studentActivitiesOverview",
		dataType: "json", //return JSON data
		data: { "from": from, "to": to, "order": order, "ThresholdSelect": ThresholdSelect, "Threshold": Threshold, "SelectCourse": SelectCourse},
		success: function (result) {
			var name = [];
			var count = [];
			var amount = [];
			$.each(result, function (i, p) {
				name[i] = p['name'];
				count[i] = p['count'];
				amount[i] = p['amount'];
			});
		StudentActivitiesOverviewAmount = amount[0];
		myChartStudentActivitiesOverview.hideLoading();
		var StudentActivitiesOverviewRelativeAmount = StudentActivitiesOverviewDiff * StudentActivitiesOverviewAmount / 100;
		// the purpose of the following code is to solve the x-label issue to ensure the accuracy and correctness of information, it will determine which stage we are at when loading the data: at the first stage, display no x-label (e-charts display some of the labels by default because there is not enough space to accommodate all the x-labels, this will provide misleading information); at the second stage, display all x-labels at a 90 degree; at the third stage, display all x-labels at a 40 degree; at the last stage, display all x-labels normally (at a 0 degree).
		if (StudentActivitiesOverviewRelativeAmount <= 8.15) {
			myChartStudentActivitiesOverview.setOption({
				xAxis: {
					data: name,
					axisLabel: {
						show: true,
						interval: 'auto',
						rotate: 0
					}
				},
				series: [{
					name: 'Amount of activities',
					data: count
				}]
			});
		} else if (StudentActivitiesOverviewRelativeAmount <= 16.3) {
			myChartStudentActivitiesOverview.setOption({
				xAxis: {
					data: name,
					axisLabel: {
						show: true,
						interval: 0,
						rotate: 40
					}
				},
				series: [{
					name: 'Amount of activities',
					data: count
				}]
			});
		} else if (StudentActivitiesOverviewRelativeAmount <= 48.9) {
			myChartStudentActivitiesOverview.setOption({
				xAxis: {
					data: name,
					axisLabel: {
						show: true,
						interval: 0,
						rotate: 90
					}
				},
				series: [{
					name: 'Amount of activities',
					data: count
				}]
			});
		} else if (StudentActivitiesOverviewRelativeAmount > 48.9) {
			myChartStudentActivitiesOverview.setOption({
				xAxis: {
					data: name,
					axisLabel: {
						show: false
					}
				},
				series: [{
					name: 'Amount of activities',
					data: count
				}]
			});
		}
		}//success
	});//ajax
}//function studentActivitiesOverviewUpdate()

//after user sets presentation order/period/threshold, update the chart "StudentActivitiesOverview"
$(document).ready(function () {
	$('#StudentActivitiesOverviewPresentationOrder').change(function () {
		studentActivitiesOverviewUpdate();
	})
	$('#StudentActivitiesOverviewSetPeriod').click(function () {
		studentActivitiesOverviewUpdate();
	})
	$('#StudentActivitiesOverviewSetThreshold').click(function () {
		studentActivitiesOverviewUpdate();
	})
})

// the purpose of the following code is to solve the x-label issue to ensure the accuracy and correctness of information, it will dynamically determine which stage we are at when the left position and right position of the slider are changed: at the first stage, display no x-label (e-charts display some of the labels by default because there is not enough space to accommodate all the x-labels, this will provide misleading information); at the second stage, display all x-labels at a 90 degree; at the third stage, display all x-labels at a 40 degree; at the last stage, display all x-labels normally (at a 0 degree).
myChartStudentActivitiesOverview.on('datazoom', function (params) {
	var diff = params.end - params.start;//difference between left and right position of the slider
	StudentActivitiesOverviewDiff = diff;
	var StudentActivitiesOverviewRelativeAmount = StudentActivitiesOverviewDiff * StudentActivitiesOverviewAmount / 100;
	console.log(StudentActivitiesOverviewRelativeAmount);
	if (StudentActivitiesOverviewRelativeAmount < 8.15) {
		myChartStudentActivitiesOverview.setOption({
			xAxis: {
				axisLabel: {
					show: true,
					interval: 'auto',
					rotate: 0
				}

			}
		});
	} else if (StudentActivitiesOverviewRelativeAmount < 16.3) {
		myChartStudentActivitiesOverview.setOption({
			xAxis: {
				axisLabel: {
					show: true,
					interval: 0,
					rotate: 40
				}

			}
		});
	} else if (StudentActivitiesOverviewRelativeAmount < 48.9) {
		myChartStudentActivitiesOverview.setOption({
			xAxis: {
				axisLabel: {
					show: true,
					interval: 0,
					rotate: 90
				}

			}
		});
	} else if (StudentActivitiesOverviewRelativeAmount >= 48.9) {
		myChartStudentActivitiesOverview.setOption({
			xAxis: {
				axisLabel: {
					show: false
				}

			}
		});
	}
});
</script>
    </main>
  </div>
</div>
</body>
</html>